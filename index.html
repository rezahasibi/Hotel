<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت و محاسبه امتیاز کارکنان</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (XLSX) library for Excel import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /*
         * Custom CSS for enhanced aesthetics and responsiveness.
         * Using Vazirmatn font for a professional Persian look.
         * Implementing Glassmorphism and subtle Neumorphism inspired effects.
         */

        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800;900&display=swap');
        
        /* Body styles: Full viewport height, centered content */
        body {
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl;
            text-align: right;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); /* Vibrant purple gradient */
            display: flex;
            justify-content: center; /* Center content horizontally */
            align-items: center; /* Center content vertically initially */
            min-height: 100vh; /* Ensure full viewport height */
            padding: 0.8rem; /* Base padding around the body */
            color: #374151; /* Default text color */
            /* Dynamic subtle background pattern for texture - Glassmorphism inspired */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.18'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 0H32v-2h4v2zm-12 0H20v-2h4v2zm24 0h-4v-2h4v2zM12 34H8v-2h4v2zM36 22v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 0H32v-2h4v2zM48 22v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 0H44v-2h4v2zM12 22v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 0H8v-2h4v2zM36 10v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 0H32v-2h4v2zM48 10v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 0H44v-2h4v2zM12 10v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 0H8v-2h4v2zM36-2v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 0H32v-2h4v2zM48-2v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 0H44v-2h4v2zM12-2v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 0H8v-2h4v2z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            background-size: 60px 60px;
            animation: backgroundPan 60s linear infinite; /* Subtle pan effect */
        }

        @keyframes backgroundPan {
            from { background-position: 0% 0%; }
            to { background-position: 100% 100%; }
        }

        /* Responsive body padding */
        @media (min-width: 640px) {
            body { padding: 1.2rem; }
        }
        @media (min-width: 1024px) {
            body { padding: 1.5rem; }
            /* When content becomes too large, align-items starts from flex-start to allow scrolling */
            body.content-overflow { align-items: flex-start; }
        }

        /* Main container wrapper styles */
        .container-wrapper {
            background-color: rgba(255, 255, 255, 0.88); /* Slightly more transparent for glass effect */
            backdrop-filter: blur(45px); /* Stronger blur for frosted glass effect */
            border-radius: 4.5rem; /* Even more rounded corners for a super soft look */
            padding: 1.8rem; /* Further reduced padding inside wrapper to bring cards closer to edge */
            /* Multi-layered shadows for depth (Neumorphism inspired) */
            box-shadow: 0 60px 200px rgba(0, 0, 0, 0.65), /* Main deep shadow */
                        0 35px 70px rgba(0, 0, 0, 0.45), /* Mid-layer shadow */
                        0 15px 30px rgba(0, 0, 0, 0.35); /* Softest top layer */
            width: 100%;
            max-width: 98vw; /* Max width closer to screen edges for "صفحه زیرین" */
            min-width: 320px; /* Minimum width for very small screens */
            display: grid;
            gap: 1.2rem; /* Further reduced gap between grid items (cards) */
            grid-template-columns: 1fr; /* Single column for small screens */
            animation: fadeIn 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; /* Smoother, bouncier fade in */
            border: 1px solid rgba(255, 255, 255, 0.98); /* Clearer, prominent glass-like border */
            margin: 0 auto; /* Crucial for horizontal centering */
        }
        /* Responsive container wrapper padding and gap */
        @media (min-width: 640px) {
            .container-wrapper { padding: 2rem; gap: 1.5rem; }
        }
        @media (min-width: 1024px) {
            .container-wrapper {
                grid-template-columns: 1fr 2.5fr; /* Larger right column for table */
                padding: 2.5rem; /* Larger padding for desktop */
                gap: 2rem; /* Larger gap for desktop */
                max-width: 1800px; /* Cap max-width on very large screens */
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(70px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card styles (inner "صفحه رویی") */
        .card {
            background-color: #ffffff;
            border-radius: 4rem; /* Very rounded cards */
            padding: 1.6rem; /* Reduced padding inside card to make content fill more */
            /* Multi-layered card shadow */
            box-shadow: 0 25px 90px rgba(0, 0, 0, 0.35),
                        0 10px 35px rgba(0, 0, 0, 0.2);
            border: 1px solid #e0e7ff; /* Light blue border */
        }
        /* Responsive card padding */
        @media (min-width: 640px) {
            .card { padding: 2rem; }
        }
        @media (min-width: 1024px) {
            .card { padding: 2.2rem; }
        }

        /* Input field styles */
        .input-field {
            border: 1px solid #cbd5e1;
            border-radius: 2rem; /* Fully rounded input fields */
            padding: 1.2rem 1.4rem; /* Adjusted padding */
            width: 100%;
            font-size: 1.05rem; /* Adjusted font size for inputs */
            background-color: #f8fafc;
            /* Subtle inner shadow for Neumorphic feel */
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.07);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #7c3aed; /* Primary purple for focus */
            /* Deeper focus ring and slight outer shadow */
            box-shadow: 0 0 0 8px rgba(124, 58, 237, 0.65), inset 0 3px 6px rgba(0,0,0,0.18);
            background-color: #ffffff;
        }
        /* Specific input fields that should remain larger */
        #employeeName, #employmentDate {
            font-size: 1.15rem; /* Larger font for these specific inputs */
            padding: 1.3rem 1.5rem;
        }

        /* Button styles */
        .btn {
            background: linear-gradient(to right, #7c3aed, #a855f7); /* Vibrant purple gradient */
            color: white;
            padding: 1.15rem 2.5rem; /* Adjusted padding */
            border-radius: 2rem; /* Very rounded buttons */
            font-weight: 800; /* Extra bold text */
            letter-spacing: 0.04em; /* Slight letter spacing */
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smoother, bouncier transition */
            box-shadow: 0 16px 45px rgba(124, 58, 237, 0.85); /* Deep, vibrant shadow */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem; /* Adjusted space for icon */
            font-size: 1.1rem; /* Adjusted font size */
            cursor: pointer;
        }
        .btn:hover {
            opacity: 0.98;
            transform: translateY(-10px) scale(1.03); /* More pronounced lift and slight scale */
            box-shadow: 0 28px 60px rgba(124, 58, 237, 1); /* Even stronger hover shadow */
        }
        .btn:active {
            transform: translateY(-3px) scale(0.97); /* Slight press-in effect */
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.65);
        }

        .btn-secondary {
            background-color: #e2e8f0;
            color: #475569;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            transition: all 0.45s ease;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.5);
        }
        .btn-secondary:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.75);
            transition: all 0.45s ease;
        }
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(239, 68, 68, 0.95);
        }
        .btn-danger:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.55);
        }

        /* Icon-only buttons for table actions - significantly smaller */
        .icon-btn {
            padding: 0.4rem; /* Further reduced padding */
            border-radius: 0.8rem; /* Smaller, but still rounded */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1; /* Keep icon centered */
            font-size: 0; /* Hide any potential text */
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .icon-btn:hover {
            transform: translateY(-2px) scale(1.1); /* Slightly more pronounced hover */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .icon-btn:active {
            transform: translateY(0) scale(0.95);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .icon-btn svg {
            width: 0.875rem; /* SVG size 14px */
            height: 0.875rem; /* SVG size 14px */
        }


        /* Table specific styles */
        .table-header {
            background-color: #e0f2fe; /* Light blue header */
            text-align: right;
            border-bottom: 2px solid #90cdf4;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th, td {
            padding: 1rem 1.2rem; /* Adjusted padding in table cells */
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.95rem; /* Adjusted table font size */
            white-space: nowrap; /* Prevent wrapping in most columns */
            color: #374151; /* Default text color for table cells */
        }
        th {
            font-weight: 900; /* Extra bold header text */
            color: #1c4e80; /* Darker blue for headers */
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.25s ease;
        }
        th:hover {
            background-color: #b3d7ff; /* Lighter blue on hover */
        }
        th .sort-icon {
            position: absolute;
            left: 0.8rem; /* Adjusted icon position */
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.9; /* More visible icon */
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        th.sorted-asc .sort-icon {
            opacity: 1;
            transform: translateY(-50%) rotate(180deg);
        }
        th.sorted-desc .sort-icon {
            opacity: 1;
            transform: translateY(-50%) rotate(0deg);
        }

        /* Zebra striping for table rows with subtle animation and gradient */
        #employeeListBody tr:nth-child(even) {
            background: linear-gradient(to right, #f7faff, #f0f7ff); /* Very light, soft blue gradient */
        }
        #employeeListBody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        #employeeListBody tr:hover {
            background: linear-gradient(to right, #e0f2fe, #d4ecff) !important; /* Noticeable hover effect with gradient */
            transform: translateY(-3px); /* Gentle lift on hover */
            box-shadow: 0 6px 15px rgba(0,0,0,0.18); /* Subtle shadow on hover */
        }
        #employeeListBody tr.editing-row {
            background: linear-gradient(to right, #fffbeb, #fff6d9) !important; /* Light yellow gradient for editing row */
            box-shadow: 0 0 0 4px #fbbf24; /* Yellow border for clarity */
            transform: translateY(-2px);
            transition: all 0.4s ease;
        }

        /* Result box styles */
        .result-box {
            background-color: #ecfeff;
            border: 1px solid #22d3ee;
            border-radius: 1.75rem;
            padding: 2rem;
            font-weight: 700;
            text-align: center;
            color: #0e7490;
            box-shadow: inset 0 5px 15px rgba(0,0,0,0.12); /* Inner shadow for depth */
        }

        /* Label styles */
        .label {
            display: block;
            margin-bottom: 1rem; /* Adjusted margin */
            font-weight: 700;
            color: #4b5563;
            font-size: 1.05rem; /* Adjusted font size */
        }

        /* Current date display styles */
        .current-date {
            font-weight: 800;
            color: #4f46e5;
            font-size: 1.3rem; /* Adjusted font size */
            margin-bottom: 3rem; /* Adjusted margin */
            text-align: center;
        }

        /* Usage date item styles */
        .usage-date-item {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(to right, #e0e7ff, #d1e0ff); /* Gradient for usage dates */
            color: #3b82f6;
            border-radius: 1.75rem; /* More rounded tags */
            padding: 0.6rem 1.2rem; /* Adjusted padding */
            margin-left: 1rem; /* Adjusted margin */
            margin-bottom: 1rem; /* Adjusted margin */
            font-size: 1rem; /* Adjusted font size */
            border: 1px solid #a7d3f8;
            height: fit-content;
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 5px 12px rgba(59, 130, 246, 0.3);
        }
        .usage-date-item:hover {
            transform: translateY(-4px) scale(1.03); /* Adjusted hover effect */
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.45);
        }
        .remove-date-btn {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 1.3rem; /* Adjusted icon size */
            cursor: pointer;
            margin-right: 1rem; /* Adjusted margin */
            line-height: 1;
            padding: 0.5rem;
            opacity: 0.95;
            transition: opacity 0.35s ease, transform 0.35s ease, background-color 0.35s ease;
            border-radius: 50%;
        }
        .remove-date-btn:hover {
            opacity: 1;
            transform: rotate(270deg) scale(1.2); /* Adjusted hover effect */
            background-color: #fee2e2;
        }

        /* Scroll container styles for table */
        .scroll-container {
            max-height: 700px; /* Adjusted max height */
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 2.2rem; /* More rounded */
            background-color: white;
            box-shadow: inset 0 6px 25px rgba(0,0,0,0.1); /* Deeper inner shadow for depth */
        }
        .search-input {
            padding-left: 4rem; /* Adjusted space for icon */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-7 w-7 text-gray-700' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1.8rem center; /* Adjusted icon position */
            background-size: 1.8rem; /* Adjusted search icon size */
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.92); /* Even darker, more opaque overlay */
            backdrop-filter: blur(20px); /* Stronger blur for ultimate frosted effect */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Base z-index for all modals */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.7s ease, visibility 0.7s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* Specific z-index for stacking order */
        #guideModalOverlay { z-index: 1010; }
        #monthlyWinnersNewModalOverlay { z-index: 1015; } /* New modal for winners selection */
        #monthlyWinnersModalOverlay { z-index: 1018; } /* Winners list slightly above if needed */
        #scoreDetailsModalOverlay { z-index: 1020; } /* Score details should always be on top */
        #customAlertOverlay { z-index: 1030; } /* Custom alerts always on top of everything */


        .modal-content {
            background-color: #ffffff;
            border-radius: 4rem; /* Very rounded modal */
            padding: 4rem; /* Adjusted padding */
            width: 90%;
            max-width: 850px; /* Adjusted modal width */
            /* Multi-layered shadows for modal */
            box-shadow: 0 45px 120px rgba(0, 0, 0, 0.85),
                        0 25px 60px rgba(0, 0, 0, 0.65);
            transform: translateY(80px) scale(0.7); /* More pronounced initial animation */
            transition: transform 0.7s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.7s ease; /* Smoother, bouncier transition */
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.98); /* Clearer glass-like border */
            position: relative;
            opacity: 0;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .modal-close-btn {
            position: absolute;
            top: 2rem; /* Adjusted position */
            left: 2rem; /* Adjusted position */
            background: none;
            border: none;
            font-size: 2.8rem; /* Adjusted close button size */
            color: #d0d0d0; /* Subtle gray */
            cursor: pointer;
            transition: color 0.4s ease, transform 0.4s ease, background-color 0.4s ease;
            line-height: 1;
            padding: 0.6rem;
            border-radius: 50%;
        }
        .modal-close-btn:hover {
            color: #ef4444;
            transform: rotate(720deg) scale(1.25); /* Multi-rotation and larger scale */
            background-color: #ffebeb;
        }
        .score-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 1.3rem 0; /* Adjusted padding */
            border-bottom: 1px dashed #e5e7eb;
            font-size: 1.15rem; /* Adjusted font size */
        }
        .score-detail-item:last-of-type {
            border-bottom: none;
        }
        .score-detail-subitem {
            padding-right: 2.8rem; /* Adjusted indent */
            color: #6b7280;
            font-size: 1.1rem; /* Adjusted font size */
        }
        .total-score-display {
            font-size: 2.2rem; /* Adjusted total score size */
            font-weight: 900;
            color: #4f46e5;
            padding-top: 2.5rem; /* Adjusted padding */
            border-top: 2px solid #e0e7ff;
            margin-top: 2.5rem; /* Adjusted margin */
        }
        
        #restoreFileInput, #excelFileInput {
            display: none;
        }

        /* Details summary (accordion header) styles */
        .details-summary {
            font-weight: 700;
            color: #4f46e5;
            cursor: pointer;
            padding: 1.3rem 0; /* Adjusted padding */
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.25rem; /* Adjusted font size */
            transition: color 0.3s ease;
            margin-bottom: 1rem; /* Added margin for spacing */
        }
        .details-summary:hover {
            color: #7c3aed;
        }
        .details-summary::marker { display: none; }
        .details-summary::-webkit-details-marker { display: none; }
        .details-summary svg {
            transition: transform 0.35s ease;
            width: 1.3rem; /* Adjusted icon size */
            height: 1.3rem; /* Adjusted icon size */
        }
        details[open] .details-summary svg {
            transform: rotate(180deg);
        }

        /* Details content (accordion body) styles */
        .details-content {
            padding: 0; /* Adjusted padding */
            border-top: 1px solid #e0e7ff;
            margin-top: 1.3rem; /* Adjusted margin */
            color: #4b5563;
            line-height: 2; /* Adjusted line height */
            font-size: 1.05rem; /* Adjusted font size */
        }
        .details-content ul {
            list-style: disc inside;
            margin-right: 3rem; /* Adjusted margin */
        }
        .details-content li {
            margin-bottom: 1rem; /* Adjusted margin */
        }

        /* --- Print Styles --- */
        @media print {
            @page {
                size: A4 landscape; /* Set page to A4 landscape */
                margin: 0.8cm; /* Adjust margins for landscape print */
            }
            body {
                background: none !important;
                padding: 0 !important;
                margin: 0 !important;
                color: black !important;
                overflow: visible !important;
                display: block !important; /* Ensure body is block for print flow */
            }

            .no-print {
                display: none !important;
            }

            .container-wrapper { /* Apply print styles to main wrapper directly */
                display: block !important; 
                position: relative !important;
                width: 100% !important; 
                max-width: 27cm !important; 
                padding: 0.5cm !important; 
                box-shadow: none !important;
                border: none !important; 
                gap: 0 !important; 
                margin: 0 auto !important; 
            }
            .container-wrapper h1 {
                text-align: center !important; 
                margin-bottom: 1.5rem !important;
                font-size: 20pt !important; 
                color: black !important;
                width: 100% !important; 
            }
            .container-wrapper .card {
                box-shadow: none !important;
                border: none !important;
                padding: 0.5rem !important;
            }
            .container-wrapper .scroll-container {
                max-height: none !important;
                overflow: visible !important;
                border: 1px solid #eee !important; 
                border-radius: 0 !important;
                width: 100% !important; 
            }
            .container-wrapper h2, .container-wrapper p, .container-wrapper .current-date {
                text-align: right !important;
                color: black !important;
                margin: 0.5rem 0 !important;
            }
            .container-wrapper .table-header {
                background-color: #e0f2fe !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                border-bottom: 1px solid #ccc !important;
                position: static !important;
            }
            .container-wrapper th, .container-wrapper td {
                border: 1px solid #eee !important;
                font-size: 9pt !important;
                padding: 0.3rem 0.5rem !important;
                white-space: normal !important; 
            }
            /* Specific column widths for print in landscape for the main table */
            .container-wrapper th[data-sort="employeeId"],
            .container-wrapper td:nth-child(1) { /* شماره پرسنلی */
                width: 16% !important; 
                max-width: 16% !important;
            }
            .container-wrapper th[data-sort="name"],
            .container-wrapper td:nth-child(2) { /* نام و نام خانوادگی */
                width: 20% !important; 
                max-width: 20% !important;
            }
            .container-wrapper th[data-sort="employmentDate"],
            .container-wrapper td:nth-child(3) { /* تاریخ استخدام */
                width: 21% !important; 
                max-width: 21% !important;
            }
            .container-wrapper th[data-sort="yearsOfService"],
            .container-wrapper td:nth-child(4) { /* سابقه (سال) */
                width: 16% !important; 
                max-width: 16% !important;
            }
            .container-wrapper th[data-sort="familyMembers"],
            .container-wrapper td:nth-child(5) { /* خانواده (نفر) */
                width: 11% !important; 
                max-width: 11% !important;
            }
            .container-wrapper th[data-sort="score"],
            .container-wrapper td:nth-child(6) { /* امتیاز نهایی */
                width: 16% !important; 
                max-width: 16% !important;
            }
            .container-wrapper td:nth-child(7) { /* ستون عملیات */
                display: none !important; 
            }

            /* Generic modal print styles */
            .modal-overlay.print-modal {
                position: fixed !important; 
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important; 
                height: 100vh !important; 
                background-color: white !important; 
                backdrop-filter: none !important;
                opacity: 1 !important;
                visibility: visible !important;
                overflow: hidden !important; 
                box-shadow: none !important;
                display: flex !important;
                align-items: flex-start !important; 
                justify-content: center !important;
                padding: 1cm !important; 
                margin: 0 !important; 
            }
            .modal-overlay.print-modal .modal-content {
                box-shadow: none !important;
                border: none !important; 
                border-radius: 0 !important;
                transform: none !important;
                opacity: 1 !important;
                padding: 1cm !important;
                width: 100% !important;
                max-width: 25cm !important; 
                max-height: none !important; 
                overflow: visible !important; 
                background-color: white !important;
                color: black !important;
            }
            .modal-overlay.print-modal .modal-close-btn {
                display: none !important;
            }
            .modal-overlay.print-modal h2,
            .modal-overlay.print-modal p,
            .modal-overlay.print-modal .score-detail-item,
            .modal-overlay.print-modal .score-detail-subitem,
            .modal-overlay.print-modal .total-score-display {
                color: black !important;
            }
            .modal-overlay.print-modal .text-green-600,
            .modal-overlay.print-modal .text-red-600 {
                color: black !important;
            }
            /* Specific print adjustments for monthly winners modal */
            .modal-overlay.print-winners-modal .monthly-winners-container {
                box-shadow: none !important;
                border: 1px solid #ccc !important; 
                padding: 1rem !important;
                background-color: white !important;
            }
            .modal-overlay.print-winners-modal .monthly-winners-container .btn {
                display: none !important;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center">
    <div class="container-wrapper">
        <!-- Left Column: Add/Edit Employee Form -->
        <div class="space-y-6">
            <h1 class="text-4xl font-extrabold text-center text-gray-800">سیستم تخصیص عادلانه واحدهای مسافرتی</h1>
            <p id="currentShamsiDateDisplay" class="current-date"></p>

            <!-- Add/Edit Employee Form -->
            <div class="card no-print">
                <h2 id="formTitle" class="text-3xl font-bold mb-6 text-gray-800">افزودن کارمند جدید</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="employeeName" class="label">نام و نام خانوادگی:</label>
                        <input type="text" id="employeeName" class="input-field" placeholder="مثال: فاطمه احمدی">
                    </div>
                    <div>
                        <label for="employeeId" class="label">شماره پرسنلی:</label>
                        <input type="text" id="employeeId" class="input-field" placeholder="مثال: 12345">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="employmentDate" class="label">تاریخ استخدام (شمسی مثال: 1390/01/15):</label>
                        <input type="text" id="employmentDate" class="input-field" placeholder="مثال: 1390/01/15" maxlength="10">
                    </div>
                    <div>
                        <label for="familyMembers" class="label">تعداد اعضای خانواده (شامل خودتان):</label>
                        <input type="number" id="familyMembers" class="input-field" min="1" value="1">
                    </div>
                </div>

                <div class="mb-6">
                    <label for="currentUsageDate" class="label">تاریخ‌های استفاده قبلی (شمسی، یک به یک وارد کنید):</label>
                    <div class="flex flex-col sm:flex-row gap-3 items-center">
                        <input type="text" id="currentUsageDate" class="input-field flex-grow" placeholder="مثال: 1401/05/20" maxlength="10">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="isPopularSlotCheckbox" class="form-checkbox h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                            <label for="isPopularSlotCheckbox" class="text-gray-700 text-sm font-medium whitespace-nowrap">آیا بازه محبوب بود؟</label>
                        </div>
                        <button onclick="addUsageDateToList()" class="btn btn-secondary px-6 py-3 w-full sm:w-auto flex-shrink-0">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            افزودن
                        </button>
                    </div>
                    <div id="usageDatesDisplay" class="mt-4 flex flex-wrap gap-3 border border-gray-200 rounded-xl p-4 min-h-[56px] bg-gray-50 items-center">
                        <span id="noUsageDatesText" class="text-gray-500 text-base">تاریخی اضافه نشده است.</span>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button id="mainFormButton" onclick="addOrUpdateEmployee()" class="btn w-full">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM12 14v5m-3-2a3 3 0 003 3h4a3 3 0 003-3v-5m-9 2h.01"></path></svg>
                        افزودن کارمند به لیست
                    </button>
                    <button id="cancelEditButton" onclick="cancelEdit()" class="btn btn-secondary w-full hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        لغو
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Column: Operational Buttons & Collapsible Employee List -->
        <div class="space-y-6">
            <div class="card p-6">
                <h2 class="text-3xl font-bold mb-5 text-gray-800">عملیات اصلی</h2>
                
                <div class="mb-6 flex flex-col sm:flex-row gap-4 no-print">
                    <button onclick="calculateAllAndSort()" class="btn flex-grow">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h9m5-4h1a2 2 0 012 2v1H7a2 2 0 00-2 2v1H4a2 2 0 00-2 2v1a2 2 0 002 2h14a2 2 0 002-2v-1a2 2 0 00-2-2h-1V7a2 2 0 012-2h-1"></path></svg>
                        محاسبه و مرتب‌سازی
                    </button>
                    <!-- New button for Monthly Winners Modal -->
                    <button onclick="showMonthlyWinnersNewModal()" class="btn flex-grow">
                        <svg class="w-6 h-6 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697A3.42 3.42 0 007 9.111v3.673a1.65 1.65 0 00.234.195l4.025 3.357a1 1 0 001.528-.484L17.5 7.5V4.25a2.25 2.25 0 00-2.25-2.25H4.25A2.25 2.25 0 002 4.25v11.5A2.25 2.25 0 004.25 18H10"></path></svg>
                        انتخاب برندگان ماه جاری
                    </button>
                    <!-- Guide Button moved here -->
                    <button onclick="showGuideModal()" class="btn btn-secondary flex-grow">
                        <svg class="w-6 h-6 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        راهنمای نرم‌افزار
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 mb-7 no-print">
                    <button onclick="exportJSONBackup()" class="btn btn-secondary flex-grow">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-2m-4-2v8m-4-8v8m-1-4h.01M3 8v4a2 2 0 002 2h14a2 2 0 002-2V8m-9 0H7"></path></svg>
                        پشتیبان‌گیری (JSON)
                    </button>
                    <input type="file" id="restoreFileInput" accept=".json" class="hidden" onchange="importFromJSONBackup(event)">
                    <button onclick="document.getElementById('restoreFileInput').click()" class="btn btn-danger flex-grow">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.085 11H3.5M2.5 9V4h4m6 10l-2 2h2m-2-2l-2-2m-2 2h8m-9 2v4a2 2 0 002 2h8a2 2 0 002-2v-4m-9 2h.01M3 8v4a2 2 0 002 2h14a2 2 0 002-2V8"></path></svg>
                        بازیابی (JSON)
                    </button>
                    <input type="file" id="excelFileInput" accept=".xlsx" class="hidden" onchange="importFromExcel(event)">
                    <button onclick="document.getElementById('excelFileInput').click()" class="btn btn-secondary flex-grow">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path></svg>
                        وارد کردن اکسل
                    </button>
                </div>
            </div>

            <!-- Collapsible Employee List -->
            <details id="employeeListDetails" class="card p-6 mt-6" open>
                <summary class="details-summary">
                    <span>لیست کارکنان متقاضی</span>
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="details-content p-0 m-0 border-none">
                    <p id="currentShamsiDateEmployeeListDisplay" class="current-date text-base mb-2"></p>
                    <div class="mb-6 flex flex-col sm:flex-row gap-4 no-print">
                        <div class="relative flex-grow">
                            <input type="text" id="searchEmployee" class="input-field search-input" placeholder="جستجو بر اساس نام، شماره پرسنلی، تاریخ..." oninput="renderEmployeeList()">
                        </div>
                        <div class="flex gap-4 w-full sm:w-auto">
                            <button onclick="exportToCSV()" class="btn btn-secondary flex-grow">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path></svg>
                                خروجی CSV
                            </button>
                            <button onclick="printEmployeeList()" class="btn btn-secondary flex-grow">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0V9a2 2 0 012-2h4a2 2 0 012 2v8m-11 0h10a2 2 0 002-2v-4a2 2 0 00-2-2H7a2 2 0 00-2 2v4a2 2 0 002 2z"></path></svg>
                                چاپ
                            </button>
                        </div>
                    </div>
                    <div class="scroll-container mb-6 overflow-x-auto">
                        <table class="min-w-full divide-y divide-blue-200 rounded-xl overflow-hidden">
                            <thead>
                                <tr class="table-header">
                                    <th class="w-[16%]" data-sort="employeeId">شماره پرسنلی <span class="sort-icon"></span></th>
                                    <th class="w-[20%]" data-sort="name">نام و نام خانوادگی <span class="sort-icon"></span></th>
                                    <th class="w-[21%]" data-sort="employmentDate">تاریخ استخدام <span class="sort-icon"></span></th>
                                    <th class="w-[16%]" data-sort="yearsOfService">سابقه (سال) <span class="sort-icon"></span></th>
                                    <th class="w-[11%]" data-sort="familyMembers">خانواده (نفر) <span class="sort-icon"></span></th>
                                    <th class="w-[16%]" data-sort="score">امتیاز نهایی <span class="sort-icon"></span></th>
                                    <th class="w-[50px] no-print">عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="employeeListBody" class="bg-white divide-y divide-gray-100">
                                <tr>
                                    <td colspan="7" class="py-4 text-center text-gray-500">هیچ کارمندی اضافه نشده است.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <!-- Score Details Modal -->
    <div id="scoreDetailsModalOverlay" class="modal-overlay" onclick="hideScoreDetails(event)">
        <div id="scoreDetailsModalContent" class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close-btn no-print" onclick="hideScoreDetails()">&times;</button>
            <h2 class="text-3xl font-bold mb-5 text-gray-800 text-center">جزئیات امتیاز کارمند</h2>
            <div id="modalEmployeeDetails" class="mb-5 text-gray-700 text-center text-lg">
                <p><span class="font-semibold">نام:</span> <span id="modalEmployeeName"></span></p>
                <p><span class="font-semibold">شماره پرسنلی:</span> <span id="modalEmployeeId"></span></p>
            </div>
            <div id="scoreBreakdown" class="space-y-3 mb-7">
                <!-- Score breakdown items will be rendered here -->
            </div>
            <div class="total-score-display text-center">
                امتیاز نهایی: <span id="modalTotalScore"></span>
            </div>
            <div class="mt-7 flex justify-center no-print">
                <button onclick="printScoreDetails()" class="btn btn-secondary px-8 py-3">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0V9a2 2 0 012-2h4a2 2 0 012 2v8m-11 0h10a2 2 0 002-2v-4a2 2 0 00-2-2H7a2 2 0 00-2 2v4a2 2 0 002 2z"></path></svg>
                    چاپ جزئیات
                </button>
            </div>
        </div>
    </div>

    <!-- Scoring Guide Modal -->
    <div id="guideModalOverlay" class="modal-overlay" onclick="hideGuideModal(event)">
        <div id="guideModalContent" class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close-btn no-print" onclick="hideGuideModal()">&times;</button>
            <h2 class="text-3xl font-bold mb-5 text-gray-800 text-center">راهنمای نرم‌افزار</h2>
            <div class="space-y-6 text-lg text-gray-700">
                <p>امتیاز نهایی هر کارمند از جمع امتیازات مثبت و منفی زیر محاسبه می‌شود:</p>
                <ul class="list-disc pr-6 mt-3">
                    <li>**امتیاز پایه:** 100 امتیاز برای همه کارمندان.</li>
                    <li>**امتیاز سابقه خدمت:** به ازای هر سال سابقه در شرکت، **10 امتیاز مثبت**.</li>
                    <li>**امتیاز اعضای خانواده:** به ازای هر نفر (شامل خود کارمند و افراد تحت تکفل), **5 امتیاز مثبت**.</li>
                    <li>**پاداش عدم استفاده:** اگر کارمند تا به حال از واحدها استفاده نکرده باشد، **200 امتیاز مثبت** (فقط یک بار).</li>
                    <li>**جریمه استفاده در سال جاری:** اگر کارمند در همین سال جاری از واحدها استفاده کرده باشد، **200- امتیاز منفی** (این جریمه فقط یک بار کسر می‌شود، حتی اگر چندین بار استفاده کرده باشد).</li>
                    <li>**جریمه استفاده در سال‌های گذشته:** به ازای هر بار استفاده در سال‌های قبل، امتیازات منفی زیر کسر می‌شود:
                        <ul class="list-disc pr-8 mt-2">
                            <li>سال گذشته: **100- امتیاز**</li>
                            <li>2 سال پیش: **50- امتیاز**</li>
                            <li>3 تا 5 سال پیش: **20- امتیاز**</li>
                            <li>6 تا 10 سال پیش: **10- امتیاز**</li>
                            <li>11 تا 20 سال پیش: **5- امتیاز**</li>
                            <li>بیشتر از 20 سال پیش: **0 امتیاز منفی**</li>
                        </ul>
                    </li>
                </ul>
                <p class="mt-4 text-base text-gray-600">مبنای محاسبه سابقه و ضرایب منفی، تاریخ روز جاری (${new Intl.DateTimeFormat('fa-IR', { year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date())}) است.</p>

                <h3 class="font-bold text-xl mt-8 text-gray-800">راهنمای وارد کردن تاریخ‌های استفاده با تعیین "بازه محبوب":</h3>
                <p class="mt-3 text-base text-gray-600">از این پس، هنگام وارد کردن تاریخ استفاده برای یک کارمند، می‌توانید مشخص کنید که آیا آن تاریخ مربوط به یک **"بازه محبوب"** بوده است یا خیر. این اطلاعات برای اعمال عدالت چرخشی در تخصیص‌ها بسیار مهم است.</p>
                <ul class="list-disc pr-6 mt-3">
                    <li>**در فرم:** کنار فیلد "تاریخ‌های استفاده قبلی"، یک چک‌باکس "آیا بازه محبوب بود؟" اضافه شده است. قبل از افزودن تاریخ، این چک‌باکس را در صورت لزوم فعال کنید.</li>
                    <li>**در فایل اکسل:**
                        <ul class="list-disc pr-8 mt-2">
                            <li>می‌توانید یک ستون جدید با عنوان `آیا بازه محبوب بود؟` به فایل اکسل خود اضافه کنید.</li>
                            <li>مقادیر قابل قبول برای این ستون: `بله`، `Yes`، `1` (برای `true`) و `خیر`، `No`، `0` (برای `false`). اگر این ستون وجود نداشته باشد یا مقدار آن نامعتبر باشد، به طور پیش‌فرض `خیر` در نظر گرفته می‌شود.</li>
                            <li>این ستون باید در کنار ستون `تاریخ‌های استفاده قبلی` قرار گیرد.</li>
                        </ul>
                    </li>
                </ul>
                <p class="mt-4 text-base text-gray-600">با این قابلیت، سیستم می‌تواند بهتر تشخیص دهد که کدام کارمند قبلاً از یک بازه محبوب استفاده کرده و عدالت در تخصیص را به نحو احسن اعمال کند.</p>

                <h3 class="font-bold text-xl mt-8 text-gray-800">راهنمای کلی وارد کردن از فایل اکسل:</h3>
                <p class="mt-3 text-base text-gray-600">برای وارد کردن لیست کارکنان از طریق فایل اکسل (`.xlsx`)، لطفاً فایل خود را با رعایت نکات زیر آماده کنید:</p>
                <ul class="list-disc pr-6 mt-3">
                    <li>**شیت اول (Sheet 1):** اطلاعات باید در شیت اول فایل اکسل شما قرار داشته باشد.</li>
                    <li>**نام ستون‌ها:** ردیف اول اکسل شما باید شامل نام ستون‌های دقیق زیر باشد (حروف کوچک و بزرگ مهم نیست، اما نام دقیق باشد):
                        <ul class="list-disc pr-8 mt-2">
                            <li>`نام` (برای نام کارمند)</li>
                            <li>`شماره پرسنلی` (برای کد پرسنلی، باید یکتا باشد)</li>
                            <li>`تاریخ استخدام` (فرمت شمسی: `YYYY/MM/DD`، مثال: `1390/01/15`)</li>
                            <li>`تعداد اعضای خانواده` (فقط عدد، مثال: `4`)</li>
                            <li>`تاریخ‌های استفاده قبلی` (اختیاری، چندین تاریخ را با کاما جدا کنید، مثال: `1400/02/10,1401/05/20`)</li>
                            <li>`آیا بازه محبوب بود؟` (اختیاری، `بله`/`Yes`/`1` یا `خیر`/`No`/`0`. اگر ستون وجود نداشته باشد یا مقدار نامعتبر بود، `خیر` در نظر گرفته می‌شود.)</li>
                        </ul>
                    </li>
                    <li>**بروزرسانی اطلاعات:** اگر `شماره پرسنلی` موجود در فایل اکسل با یک کارمند ثبت شده در سیستم مطابقت داشته باشد، اطلاعات آن کارمند (شامل نام، تاریخ استخدام، تعداد خانواده و تاریخ‌های استفاده) **بروزرسانی** خواهد شد.</li>
                    <li>**فرمت تاریخ:** تمامی تاریخ‌ها باید به فرمت شمسی `سال/ماه/روز` (مثال: `1403/05/20`) وارد شوند.</li>
                </ul>
                <p class="mt-4 text-base text-gray-600">پس از آماده‌سازی فایل، دکمه "وارد کردن اکسل" را کلیک کرده و فایل خود را انتخاب کنید.</p>
            </div>
        </div>
    </div>

    <!-- Monthly Winners Selection Modal (New Modal for Input) -->
    <div id="monthlyWinnersNewModalOverlay" class="modal-overlay" onclick="hideMonthlyWinnersNewModal(event)">
        <div id="monthlyWinnersNewModalContent" class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close-btn no-print" onclick="hideMonthlyWinnersNewModal()">&times;</button>
            <h2 class="text-3xl font-bold mb-5 text-gray-800 text-center">انتخاب برندگان ماه جاری</h2>
            <div class="mb-6">
                <label for="monthlyQuota" class="label">تعداد سهمیه ماه جاری (نفر):</label>
                <input type="number" id="monthlyQuota" class="input-field" min="1" value="1">
            </div>
            <button onclick="selectMonthlyWinners()" class="btn w-full">
                <svg class="w-6 h-6 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697A3.42 3.42 0 007 9.111v3.673a1.65 1.65 0 00.234.195l4.025 3.357a1 1 0 001.528-.484L17.5 7.5V4.25a2.25 2.25 0 00-2.25-2.25H4.25A2.25 2.25 0 002 4.25v11.5A2.25 2.25 0 004.25 18H10"></path></svg>
                انتخاب و نمایش برندگان
            </button>
        </div>
    </div>

    <!-- Monthly Winners Display Modal -->
    <div id="monthlyWinnersModalOverlay" class="modal-overlay" onclick="hideMonthlyWinnersModal(event)">
        <div id="monthlyWinnersModalContent" class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close-btn no-print" onclick="hideMonthlyWinnersModal()">&times;</button>
            <h2 class="text-3xl font-bold mb-5 text-gray-800 text-center">برندگان ماه جاری</h2>
            <p id="currentShamsiDateWinnersDisplay" class="current-date text-base mb-2"></p>
            <div id="monthlyWinnersContainer" class="monthly-winners-container p-4 border border-blue-300 rounded-xl bg-blue-50 min-h-[100px] flex flex-col justify-center items-center">
                <p id="noWinnersTextModal" class="text-blue-600 font-medium">برندگان ماه هنوز انتخاب نشده‌اند.</p>
            </div>
            <div class="mt-7 flex justify-center gap-4 no-print">
                <button onclick="exportWinnersToCSV()" class="btn btn-secondary px-8 py-3">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path></svg>
                    خروجی CSV برندگان
                </button>
                <button onclick="printMonthlyWinners()" class="btn btn-secondary px-8 py-3">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0V9a2 2 0 012-2h4a2 2 0 012 2v8m-11 0h10a2 2 0 002-2v-4a2 2 0 00-2-2H7a2 2 0 00-2 2v4a2 2 0 002 2z"></path></svg>
                    چاپ لیست برندگان
                </button>
            </div>
        </div>
    </div>


    <!-- Custom Alert/Confirm Modal for Lottery -->
    <div id="customAlertOverlay" class="modal-overlay">
        <div class="modal-content max-w-md p-8 text-center" onclick="event.stopPropagation()">
            <h3 id="customAlertTitle" class="text-2xl font-bold mb-4 text-gray-800"></h3>
            <p id="customAlertMessage" class="text-lg text-gray-700 mb-6"></p>
            <div id="customAlertActions" class="flex justify-center gap-4">
                <button id="customAlertConfirm" class="btn px-6 py-3">تایید</button>
                <button id="customAlertCancel" class="btn btn-secondary px-6 py-3">لغو</button>
            </div>
        </div>
    </div>


    <script>
        // --- Global Variables and IndexedDB Setup ---
        const DB_NAME = 'EmployeeDB_V2'; // Original DB name for the main application
        const DB_VERSION = 2; // Keep DB version 2 for popular slot structure
        const STORE_NAME = 'employees';
        let db;

        let employees = []; // Global array to hold employee data from IndexedDB
        // usageDates now stores objects: { date: "YYYY/MM/DD", isPopularSlot: boolean }
        let currentEmployeeUsageDates = []; // Temporary storage for usage dates while adding an employee
        let editingEmployeeId = null; // Stores the ID of the employee being edited, null when adding new

        // DOM Elements
        const employeeNameInput = document.getElementById('employeeName');
        const employeeIdInput = document.getElementById('employeeId');
        const employmentDateInput = document.getElementById('employmentDate');
        const familyMembersInput = document.getElementById('familyMembers');
        const currentUsageDateInput = document.getElementById('currentUsageDate');
        const isPopularSlotCheckbox = document.getElementById('isPopularSlotCheckbox'); // New checkbox
        const usageDatesDisplay = document.getElementById('usageDatesDisplay');
        const searchEmployeeInput = document.getElementById('searchEmployee'); // Now in the collapsible section
        const employeeListBody = document.getElementById('employeeListBody'); // Original table body ID, now in collapsible section

        const scoreDetailsModalOverlay = document.getElementById('scoreDetailsModalOverlay');
        const scoreDetailsModalContent = document.getElementById('scoreDetailsModalContent');
        const modalEmployeeName = document.getElementById('modalEmployeeName');
        const modalEmployeeId = document.getElementById('modalEmployeeId');
        const scoreBreakdownDiv = document.getElementById('scoreBreakdown');
        const modalTotalScoreSpan = document.getElementById('modalTotalScore');

        // New modal elements for guide
        const guideModalOverlay = document.getElementById('guideModalOverlay');
        const guideModalContent = document.getElementById('guideModalContent');

        const formTitle = document.getElementById('formTitle');
        const mainFormButton = document.getElementById('mainFormButton');
        const cancelEditButton = document.getElementById('cancelEditButton');

        // New DOM elements for monthly quota selection modal
        const monthlyQuotaInput = document.getElementById('monthlyQuota');
        const monthlyWinnersNewModalOverlay = document.getElementById('monthlyWinnersNewModalOverlay');
        const monthlyWinnersNewModalContent = document.getElementById('monthlyWinnersNewModalContent');

        // New DOM elements for monthly winners display modal
        const monthlyWinnersModalOverlay = document.getElementById('monthlyWinnersModalOverlay');
        const monthlyWinnersModalContent = document.getElementById('monthlyWinnersModalContent');
        const monthlyWinnersContainer = document.getElementById('monthlyWinnersContainer');
        const noWinnersTextModal = document.getElementById('noWinnersTextModal');
        const currentShamsiDateWinnersDisplay = document.getElementById('currentShamsiDateWinnersDisplay');

        // DOM elements for Collapsible Employee List Section
        const employeeListDetails = document.getElementById('employeeListDetails');
        const currentShamsiDateEmployeeListDisplay = document.getElementById('currentShamsiDateEmployeeListDisplay');

        // Custom Alert/Confirm Modal elements
        const customAlertOverlay = document.getElementById('customAlertOverlay');
        const customAlertTitle = document.getElementById('customAlertTitle');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertConfirmBtn = document.getElementById('customAlertConfirm');
        const customAlertCancelBtn = document.getElementById('customAlertCancel');

        let sortColumn = 'score'; // Default sort column
        let sortDirection = 'desc'; // Default sort direction

        // --- Shamsi Date and Persian Number Helpers ---

        // Converts Western digits to Persian digits
        function toPersianDigits(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
        }

        // Converts Persian digits to Western digits
        function toWesternDigits(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
        }

        // Function to determine the current Shamsi year based on a more robust approach
        function getCurrentShamsiYearAccurate() {
            const today = new Date();
            const gregorianYear = today.getFullYear();
            const gregorianMonth = today.getMonth(); // 0-11
            const gregorianDay = today.getDate();

            let currentShamsiYear;
            if (gregorianMonth < 2 || (gregorianMonth === 2 && gregorianDay < 20)) {
                currentShamsiYear = gregorianYear - 622;
            } else {
                currentShamsiYear = gregorianYear - 621;
            }
            return currentShamsiYear;
        }

        // Converts Gregorian date to Shamsi date parts string (e.g., "1403/05/01")
        function getShamsiDateString(date) {
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            const formatter = new Intl.DateTimeFormat('fa-IR', options);
            return formatter.format(date);
        }

        // Helper to get Shamsi year from a "YYYY/MM/DD" string (assumes Western digits internally)
        function getShamsiYearFromDateString(shamsiDateString) {
            const westernDateString = toWesternDigits(shamsiDateString);
            const parts = westernDateString.split('/');
            if (parts.length === 3) {
                return parseInt(parts[0]);
            }
            return NaN;
        }

        const today = new Date();
        const CURRENT_SHAMSI_YEAR = getCurrentShamsiYearAccurate();
        const CURRENT_SHAMSI_FULL_DATE = getShamsiDateString(today);

        document.getElementById('currentShamsiDateDisplay').textContent = `تاریخ امروز: ${toPersianDigits(CURRENT_SHAMSI_FULL_DATE)}`;

        // Auto-formats date input to YYYY/MM/DD and converts to Persian digits
        function formatShamsiDateInput(event) {
            let value = event.target.value;
            value = toWesternDigits(value);

            // Remove non-digit and non-slash characters
            value = value.replace(/[^0-9/]/g, '');

            // Auto-insert slashes
            if (value.length === 4 && event.inputType !== 'deleteContentBackward' && !value.endsWith('/')) {
                value += '/';
            }
            if (value.length === 7 && event.inputType !== 'deleteContentBackward' && value.split('/').length < 3) {
                value += '/';
            }

            // Limit length
            if (value.length > 10) {
                value = value.substring(0, 10);
            }

            // Convert back to Persian digits for display
            event.target.value = toPersianDigits(value);
        }

        employmentDateInput.addEventListener('input', formatShamsiDateInput);
        currentUsageDateInput.addEventListener('input', formatShamsiDateInput);


        // --- IndexedDB Functions ---

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('employeeId', 'employeeId', { unique: true });
                        objectStore.createIndex('name', 'name', { unique: false });
                    }
                    // For version 2, if usageDates was an array of strings, convert it to array of objects
                    if (event.oldVersion < 2 && db.objectStoreNames.contains(STORE_NAME)) {
                        const transaction = event.currentTarget.transaction;
                        const store = transaction.objectStore(STORE_NAME);
                        store.openCursor().onsuccess = (e) => {
                            const cursor = e.target.result;
                            if (cursor) {
                                const employee = { ...cursor.value };
                                if (Array.isArray(employee.usageDates) && employee.usageDates.every(d => typeof d === 'string')) {
                                    employee.usageDates = employee.usageDates.map(date => ({
                                        date: date,
                                        isPopularSlot: false // Default existing dates to not popular
                                    }));
                                    cursor.update(employee);
                                }
                                cursor.continue();
                            }
                        };
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.errorCode, event.target.error);
                    showCustomAlert('خطا در پایگاه داده', 'خطا در باز کردن پایگاه داده. لطفاً مرورگر را بررسی کنید.', 'alert');
                    reject('خطا در باز کردن پایگاه داده. لطفاً مرورگر را بررسی کنید.');
                };
            });
        }

        async function addEmployeeToDB(employee) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(employee);

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    if (event.target.error.name === 'ConstraintError') {
                        reject('شماره پرسنلی تکراری است. لطفاً یک شماره منحصر به فرد وارد کنید.');
                    } else {
                        console.error('Error adding employee to DB:', event.target.error);
                        reject('خطا در افزودن کارمند به پایگاه داده.');
                    }
                };
            });
        }

        async function clearAllEmployeesInDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();

                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error('Error clearing employees from DB:', event.target.error);
                    reject('خطا در پاک کردن اطلاعات کارکنان از پایگاه داده.');
                };
            });
        }

        async function getEmployeesFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    console.error('Error getting employees from DB:', event.target.error);
                    reject('خطا در دریافت اطلاعات کارکنان از پایگاه داده.');
                };
            });
        }

        async function updateEmployeeInDB(employee) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(employee);

                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    if (event.target.error.name === 'ConstraintError') {
                        reject('شماره پرسنلی تکراری است. لطفاً یک شماره منحصر به فرد وارد کنید.');
                    } else {
                        console.error('Error updating employee in DB:', event.target.error);
                        reject('خطا در به روزرسانی کارمند در پایگاه داده.');
                    }
                };
            });
        }

        async function deleteEmployeeFromDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error('Error deleting employee from DB:', event.target.error);
                    reject('خطا در حذف کارمند از پایگاه داده.');
                };
                
            });
        }

        // Custom Alert/Confirm Logic
        function showCustomAlert(title, message, type = 'alert') { // 'alert' or 'confirm'
            return new Promise((resolve) => {
                customAlertTitle.textContent = title;
                customAlertMessage.textContent = message;

                if (type === 'confirm') {
                    customAlertConfirmBtn.classList.remove('hidden');
                    customAlertCancelBtn.classList.remove('hidden');
                } else {
                    customAlertConfirmBtn.classList.remove('hidden'); // For alert, 'Confirm' acts as 'OK'
                    customAlertCancelBtn.classList.add('hidden');
                }

                customAlertOverlay.classList.add('show');

                const handleConfirm = () => {
                    customAlertOverlay.classList.remove('show');
                    customAlertConfirmBtn.removeEventListener('click', handleConfirm);
                    customAlertCancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    customAlertOverlay.classList.remove('show');
                    customAlertConfirmBtn.removeEventListener('click', handleConfirm);
                    customAlertCancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                customAlertConfirmBtn.addEventListener('click', handleConfirm);
                customAlertCancelBtn.addEventListener('click', handleCancel);

                // Prevent closing by clicking outside for custom confirm
                if (type === 'confirm') {
                    customAlertOverlay.removeEventListener('click', hideCustomAlert);
                } else {
                    customAlertOverlay.addEventListener('click', hideCustomAlert);
                }
            });
        }

        function hideCustomAlert(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            customAlertOverlay.classList.remove('show');
        }


        // --- Scoring Logic ---
        function calculateEmployeeScore(employee) {
            let score = 100;

            const employmentYear = getShamsiYearFromDateString(employee.employmentDate);
            const yearsOfService = !isNaN(employmentYear) ? Math.max(0, CURRENT_SHAMSI_YEAR - employmentYear) : 0;
            score += yearsOfService * 10;
            
            score += employee.familyMembers * 5;

            const usageDates = employee.usageDates; // Now array of objects
            if (usageDates.length === 0) {
                score += 200;
            } else {
                let hasUsedThisYear = false;
                let totalPastUsagePenalty = 0;

                usageDates.forEach(usageItem => {
                    const dateString = usageItem.date;
                    const usageYear = getShamsiYearFromDateString(dateString);
                    if (isNaN(usageYear)) {
                        console.warn(`[Scoring Error] Invalid usage date for ${employee.name}: ${dateString}`);
                        return;
                    }

                    const yearsAgo = CURRENT_SHAMSI_YEAR - usageYear;

                    if (yearsAgo === 0) {
                        hasUsedThisYear = true;
                    } else if (yearsAgo === 1) {
                        totalPastUsagePenalty -= 100;
                    } else if (yearsAgo === 2) {
                        totalPastUsagePenalty -= 50;
                    } else if (yearsAgo >= 3 && yearsAgo <= 5) {
                        totalPastUsagePenalty -= 20;
                    } else if (yearsAgo >= 6 && yearsAgo <= 10) {
                        totalPastUsagePenalty -= 10;
                    } else if (yearsAgo >= 11 && yearsAgo <= 20) {
                        totalPastUsagePenalty -= 5;
                    }
                });

                if (hasUsedThisYear) {
                    score -= 200;
                }
                score += totalPastUsagePenalty;
            }
            return score;
        }

        // Function to get detailed score breakdown
        function getScoreBreakdown(employee) {
            let breakdown = {
                baseScore: 100,
                servicePoints: 0,
                familyPoints: 0,
                neverUsedBonus: 0,
                usedThisYearPenalty: 0,
                pastUsagePenalties: [],
                totalScore: 0
            };

            breakdown.totalScore += breakdown.baseScore;

            const employmentYear = getShamsiYearFromDateString(employee.employmentDate);
            const yearsOfService = !isNaN(employmentYear) ? Math.max(0, CURRENT_SHAMSI_YEAR - employmentYear) : 0;
            breakdown.servicePoints = yearsOfService * 10;
            breakdown.totalScore += breakdown.servicePoints;

            breakdown.familyMembers = employee.familyMembers; // This is the count, not the points
            breakdown.totalScore += breakdown.familyMembers * 5; // Calculate actual family points

            const usageDates = employee.usageDates; // Now array of objects
            if (usageDates.length === 0) {
                breakdown.neverUsedBonus = 200;
                breakdown.totalScore += breakdown.neverUsedBonus;
            } else {
                let hasUsedThisYear = false;

                usageDates.forEach(usageItem => {
                    const dateString = usageItem.date;
                    const isPopular = usageItem.isPopularSlot; // Use isPopularSlot here
                    const usageYear = getShamsiYearFromDateString(dateString);
                    if (isNaN(usageYear)) return;

                    const yearsAgo = CURRENT_SHAMSI_YEAR - usageYear;
                    let penalty = 0;

                    if (yearsAgo === 0) {
                        hasUsedThisYear = true;
                    } else if (yearsAgo === 1) {
                        penalty = -100;
                    } else if (yearsAgo === 2) {
                        penalty = -50;
                    } else if (yearsAgo >= 3 && yearsAgo <= 5) {
                        penalty = -20;
                    } else if (yearsAgo >= 6 && yearsAgo <= 10) {
                        penalty = -10;
                    } else if (yearsAgo >= 11 && yearsAgo <= 20) {
                        penalty = -5;
                    }
                    if (penalty !== 0) {
                        breakdown.pastUsagePenalties.push({ year: usageYear, penalty: penalty, date: dateString, isPopular: isPopular });
                        breakdown.totalScore += penalty;
                    }
                });

                if (hasUsedThisYear) {
                    breakdown.usedThisYearPenalty = -200;
                    breakdown.totalScore += breakdown.usedThisYearPenalty;
                }
            }
            return breakdown;
        }


        // --- UI Rendering and Management Functions ---

        // Adds a usage date to the temporary list
        function addUsageDateToList() {
            let date = currentUsageDateInput.value.trim();
            date = toWesternDigits(date);
            const isPopular = isPopularSlotCheckbox.checked; // Get checkbox state

            const dateRegex = /^\d{4}\/\d{2}\/\d{2}$/;
            if (!dateRegex.test(date)) {
                showCustomAlert('خطای ورودی', 'لطفاً یک تاریخ شمسی معتبر (مثال: 1401/05/20) وارد کنید.', 'alert');
                return;
            }
            
            // Check if date already exists in the list to prevent duplicates
            const existingDateIndex = currentEmployeeUsageDates.findIndex(item => item.date === date);
            if (existingDateIndex === -1) {
                currentEmployeeUsageDates.push({ date: date, isPopularSlot: isPopular });
            } else {
                // If date exists, update its popular status
                currentEmployeeUsageDates[existingDateIndex].isPopularSlot = isPopular;
            }
            
            renderCurrentUsageDates();
            currentUsageDateInput.value = '';
            isPopularSlotCheckbox.checked = false; // Reset checkbox
        }

        // Renders the temporary list of usage dates
        function renderCurrentUsageDates() {
            usageDatesDisplay.innerHTML = '';
            if (currentEmployeeUsageDates.length === 0) {
                const span = document.createElement('span');
                span.id = 'noUsageDatesText';
                span.className = 'text-gray-500 text-base';
                span.textContent = 'تاریخی اضافه نشده است.';
                usageDatesDisplay.appendChild(span);
                return;
            }
            currentEmployeeUsageDates.forEach((usageItem, index) => {
                const span = document.createElement('span');
                span.className = 'usage-date-item';
                span.innerHTML = `
                    ${toPersianDigits(usageItem.date)}
                    ${usageItem.isPopularSlot ? ' <span class="text-red-500">(محبوب)</span>' : ''}
                    <button type="button" class="remove-date-btn" data-index="${index}" onclick="removeUsageDate(event)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                usageDatesDisplay.appendChild(span);
            });
            const existingNoText = document.getElementById('noUsageDatesText');
            if (existingNoText) existingNoText.remove();
        }

        // Removes a usage date from the temporary list
        function removeUsageDate(event) {
            const indexToRemove = parseInt(event.target.closest('button').dataset.index);
            currentEmployeeUsageDates.splice(indexToRemove, 1);
            renderCurrentUsageDates();
        }

        // Handles adding or updating an employee based on `editingEmployeeId`
        async function addOrUpdateEmployee() {
            const name = employeeNameInput.value.trim();
            const employeeId = employeeIdInput.value.trim();
            let employmentDate = employmentDateInput.value.trim();
            const familyMembers = parseInt(familyMembersInput.value);

            employmentDate = toWesternDigits(employmentDate);
            const westernEmployeeId = toWesternDigits(employeeId);

            const dateRegex = /^\d{4}\/\d{2}\/\d{2}$/;
            if (!name || !employeeId || !dateRegex.test(employmentDate) || isNaN(familyMembers) || familyMembers < 1) {
                showCustomAlert('خطای ورودی', 'لطفاً نام، شماره پرسنلی، تاریخ استخدام معتبر (مانند 1390/01/15) و تعداد اعضای خانواده (حداقل 1) را به درستی وارد کنید.', 'alert');
                return;
            }

            const isDuplicateId = employees.some(emp =>
                emp.employeeId === westernEmployeeId && emp.id !== editingEmployeeId
            );
            if (isDuplicateId) {
                showCustomAlert('خطای تکراری', 'شماره پرسنلی تکراری است. لطفاً یک شماره منحصر به فرد وارد کنید.', 'alert');
                return;
            }

            const employeeData = {
                name,
                employeeId: westernEmployeeId,
                employmentDate,
                familyMembers,
                usageDates: [...currentEmployeeUsageDates], // Use the new structure
                score: 0
            };

            try {
                if (editingEmployeeId !== null) {
                    employeeData.id = editingEmployeeId;
                    await updateEmployeeInDB(employeeData);
                    const index = employees.findIndex(emp => emp.id === editingEmployeeId);
                    if (index > -1) {
                        employees[index] = employeeData;
                    }
                    showCustomAlert('موفقیت', 'اطلاعات کارمند با موفقیت به‌روزرسانی شد.', 'alert');
                } else {
                    const id = await addEmployeeToDB(employeeData);
                    employeeData.id = id;
                    employees.push(employeeData);
                    showCustomAlert('موفقیت', 'کارمند جدید با موفقیت اضافه شد.', 'alert');
                }
                renderEmployeeList(); // Re-render the collapsible list
                cancelEdit();
            } catch (error) {
                showCustomAlert('خطا در ذخیره', 'خطا در ذخیره اطلاعات کارمند: ' + error, 'alert');
            }
        }

        // Sets the form to edit mode with selected employee's data
        function editEmployee(idToEdit) {
            const employee = employees.find(emp => emp.id === idToEdit);
            if (!employee) {
                showCustomAlert('خطا', 'کارمند مورد نظر یافت نشد.', 'alert');
                return;
            }

            editingEmployeeId = idToEdit;
            formTitle.textContent = 'ویرایش اطلاعات کارمند';
            mainFormButton.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg> به‌روزرسانی کارمند`;
            mainFormButton.classList.remove('btn');
            mainFormButton.classList.add('btn-edit');
            cancelEditButton.classList.remove('hidden');

            employeeNameInput.value = toPersianDigits(employee.name);
            employeeIdInput.value = toPersianDigits(employee.employeeId);
            employmentDateInput.value = toPersianDigits(employee.employmentDate);
            familyMembersInput.value = employee.familyMembers;
            
            // Ensure currentEmployeeUsageDates is an array of objects
            currentEmployeeUsageDates = employee.usageDates.map(item => {
                // Handle potential old string format for existing data if DB was not migrated, though onupgradeneeded should handle it.
                if (typeof item === 'string') {
                    return { date: item, isPopularSlot: false };
                }
                return { date: item.date, isPopularSlot: item.isPopularSlot || false };
            });
            renderCurrentUsageDates();
            renderEmployeeList(); // Re-render the collapsible table to highlight editing row
        }

        // Resets the form to add new employee mode
        function cancelEdit() {
            editingEmployeeId = null;
            formTitle.textContent = 'افزودن کارمند جدید';
            mainFormButton.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM12 14v5m-3-2a3 3 0 003 3h4a3 3 0 003-3v-5m-9 2h.01"></path></svg> افزودن کارمند به لیست`;
            mainFormButton.classList.remove('btn-edit');
            mainFormButton.classList.add('btn');
            cancelEditButton.classList.add('hidden');

            employeeNameInput.value = '';
            employeeIdInput.value = '';
            employmentDateInput.value = '';
            familyMembersInput.value = '1';
            currentUsageDateInput.value = '';
            isPopularSlotCheckbox.checked = false; // Reset checkbox
            currentEmployeeUsageDates = [];
            renderCurrentUsageDates();
            renderEmployeeList(); // Re-render the collapsible table to remove highlight
        }


        // Removes an employee from the list and DB
        async function removeEmployee(idToRemove) {
            const confirmed = await showCustomAlert('تایید حذف', 'آیا از حذف این کارمند مطمئن هستید؟ این عملیات قابل بازگشت نیست.', 'confirm');
            if (!confirmed) return;

            try {
                await deleteEmployeeFromDB(idToRemove);
                const index = employees.findIndex(emp => emp.id === idToRemove);
                if (index > -1) {
                    employees.splice(index, 1);
                }
                renderEmployeeList(); // Re-render the collapsible table
                if (editingEmployeeId === idToRemove) {
                    cancelEdit();
                }
            } catch (error) {
                showCustomAlert('خطا در حذف', 'خطا در حذف کارمند: ' + error, 'alert');
            }
        }

        // Renders the main employee list table, including search and sort
        function renderEmployeeList() {
            const targetBody = employeeListBody; 
            const targetSearchInput = searchEmployeeInput;

            targetBody.innerHTML = '';

            let filteredEmployees = employees;
            const searchTerm = toWesternDigits(targetSearchInput.value.trim().toLowerCase());

            if (searchTerm) {
                filteredEmployees = employees.filter(emp =>
                    toWesternDigits(emp.name.toLowerCase()).includes(searchTerm) ||
                    toWesternDigits(emp.employeeId.toLowerCase()).includes(searchTerm) ||
                    toWesternDigits(emp.employmentDate.toLowerCase()).includes(searchTerm) ||
                    toWesternDigits(emp.familyMembers.toString()).includes(searchTerm) ||
                    (emp.score !== 0 && toPersianDigits(emp.score.toString()).includes(searchTerm)) ||
                    emp.usageDates.some(item => toWesternDigits(item.date).includes(searchTerm))
                );
            }

            filteredEmployees.sort((a, b) => {
                let valA, valB;

                if (sortColumn === 'yearsOfService') {
                    const yearsA = CURRENT_SHAMSI_YEAR - getShamsiYearFromDateString(a.employmentDate);
                    const yearsB = CURRENT_SHAMSI_YEAR - getShamsiYearFromDateString(b.employmentDate);
                    valA = isNaN(yearsA) ? -Infinity : Math.max(0, yearsA);
                    valB = isNaN(yearsB) ? -Infinity : Math.max(0, yearsB);
                } else if (sortColumn === 'name' || sortColumn === 'employeeId' || sortColumn === 'employmentDate') {
                    valA = toWesternDigits(a[sortColumn]);
                    valB = toWesternDigits(b[sortColumn]);
                } else { // familyMembers, score
                    valA = a[sortColumn];
                    valB = b[sortColumn];
                }

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });


            if (filteredEmployees.length === 0) {
                targetBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-4 text-center text-gray-500">هیچ کارمندی یافت نشد.</td>
                    </tr>
                `;
                return;
            }

            filteredEmployees.forEach(emp => {
                const row = document.createElement('tr');
                if (editingEmployeeId === emp.id) {
                    row.classList.add('editing-row');
                }

                const yearsOfService = CURRENT_SHAMSI_YEAR - getShamsiYearFromDateString(emp.employmentDate);
                
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm text-gray-700 cursor-pointer" onclick="showScoreDetails(${emp.id})">${toPersianDigits(emp.employeeId)}</td>
                    <td class="py-3 px-4 text-sm text-gray-700 cursor-pointer" onclick="showScoreDetails(${emp.id})">${toPersianDigits(emp.name)}</td>
                    <td class="py-3 px-4 text-sm text-gray-700 cursor-pointer" onclick="showScoreDetails(${emp.id})">${toPersianDigits(emp.employmentDate)}</td>
                    <td class="py-3 px-4 text-sm text-gray-700 cursor-pointer" onclick="showScoreDetails(${emp.id})">${isNaN(yearsOfService) ? 'نامعتبر' : toPersianDigits(Math.max(0, yearsOfService).toString())} سال</td>
                    <td class="py-3 px-4 text-sm text-gray-700 cursor-pointer" onclick="showScoreDetails(${emp.id})">${toPersianDigits(emp.familyMembers.toString())} نفر</td>
                    <td class="py-3 px-4 text-sm text-indigo-700 font-semibold cursor-pointer" onclick="showScoreDetails(${emp.id})">${emp.score === 0 ? 'محاسبه نشده' : toPersianDigits(emp.score.toString())}</td>
                    <td class="py-3 px-4 text-sm text-center no-print">
                        <div class="flex gap-1 justify-center"> <!-- Further reduced gap between buttons -->
                            <button onclick="event.stopPropagation(); editEmployee(${emp.id});" class="icon-btn btn-edit">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L15.232 5.232z"></path></svg>
                            </button>
                            <button onclick="event.stopPropagation(); removeEmployee(${emp.id})" class="icon-btn btn-danger">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </td>
                `;
                targetBody.appendChild(row);
            });

            // Update sort icons for the collapsible table headers
            document.querySelectorAll('#employeeListDetails th[data-sort]').forEach(th => {
                const icon = th.querySelector('.sort-icon');
                if (icon) {
                    th.classList.remove('sorted-asc', 'sorted-desc');
                    icon.innerHTML = '';
                    if (th.dataset.sort === sortColumn) {
                        th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                        icon.innerHTML = sortDirection === 'asc' ? '&#9650;' : '&#9660;';
                    }
                }
            });
        }

        // Handles sorting when a table header is clicked
        function handleSort(event) {
            const column = event.currentTarget.dataset.sort;
            if (!column) return;

            if (sortColumn === column) {
                sortDirection = (sortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            renderEmployeeList(); // Re-render the collapsible list
        }

        document.querySelectorAll('#employeeListDetails th[data-sort]').forEach(th => {
            th.addEventListener('click', handleSort);
        });


        // Calculates scores for all employees and sorts them, then updates DB
        async function calculateAllAndSort() {
            if (employees.length === 0) {
                showCustomAlert('اطلاعات ناکافی', 'لطفاً حداقل یک کارمند اضافه کنید تا امتیازات محاسبه شوند.', 'alert');
                return;
            }

            for (const emp of employees) {
                emp.score = calculateEmployeeScore(emp);
                await updateEmployeeInDB(emp);
            }

            sortColumn = 'score';
            sortDirection = 'desc';

            renderEmployeeList(); // Update the collapsible list
            showCustomAlert('محاسبه انجام شد', 'امتیازات تمامی کارکنان محاسبه و لیست مرتب‌سازی شد.', 'alert');
        }

        // --- Score Details Modal Functions ---
        function showScoreDetails(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;

            const breakdown = getScoreBreakdown(employee);

            modalEmployeeName.textContent = toPersianDigits(employee.name);
            modalEmployeeId.textContent = toPersianDigits(employee.employeeId);
            modalTotalScoreSpan.textContent = toPersianDigits(breakdown.totalScore.toString());

            scoreBreakdownDiv.innerHTML = `
                <div class="score-detail-item">
                    <span>امتیاز پایه</span>
                    <span class="font-semibold">${toPersianDigits(breakdown.baseScore.toString())}</span>
                </div>
                <div class="score-detail-item">
                    <span>امتیاز سابقه خدمت (${toPersianDigits(Math.max(0, (CURRENT_SHAMSI_YEAR - getShamsiYearFromDateString(employee.employmentDate))).toString())} سال)</span>
                    <span class="font-semibold">${toPersianDigits(breakdown.servicePoints.toString())}</span>
                </div>
                <div class="score-detail-item">
                    <span>امتیاز اعضای خانواده (${toPersianDigits(employee.familyMembers.toString())} نفر)</span>
                    <span class="font-semibold">${toPersianDigits((breakdown.familyMembers * 5).toString())}</span>
                </div>
            `;

            if (breakdown.neverUsedBonus > 0) {
                scoreBreakdownDiv.innerHTML += `
                    <div class="score-detail-item">
                        <span>پاداش عدم استفاده (تا به حال)</span>
                        <span class="font-semibold text-green-600">+${toPersianDigits(breakdown.neverUsedBonus.toString())}</span>
                    </div>
                `;
            }

            if (breakdown.usedThisYearPenalty < 0) {
                scoreBreakdownDiv.innerHTML += `
                    <div class="score-detail-item">
                        <span>جریمه استفاده در سال جاری</span>
                        <span class="font-semibold text-red-600">${toPersianDigits(breakdown.usedThisYearPenalty.toString())}</span>
                    </div>
                `;
            }

            if (breakdown.pastUsagePenalties.length > 0) {
                scoreBreakdownDiv.innerHTML += `
                    <div class="score-detail-item flex-col items-start">
                        <span>جریمه استفاده در سال‌های گذشته:</span>
                        <div class="w-full mt-2 space-y-1">
                            ${breakdown.pastUsagePenalties.map(p => `
                                <div class="score-detail-subitem flex justify-between">
                                    <span>استفاده در ${toPersianDigits(p.date)} (${toPersianDigits(p.year.toString())})${p.isPopular ? ' <span class="text-red-500">(بازه محبوب)</span>' : ''}</span>
                                    <span class="font-semibold text-red-600">${toPersianDigits(p.penalty.toString())}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            scoreDetailsModalOverlay.classList.add('show');
        }

        function hideScoreDetails(event) {
            if (event && event.target !== event.currentTarget && !event.target.classList.contains('modal-close-btn')) {
                return;
            }
            scoreDetailsModalOverlay.classList.remove('show');
        }

        // --- Guide Modal Functions ---
        function showGuideModal() {
            guideModalOverlay.classList.add('show');
        }

        function hideGuideModal(event) {
            if (event && event.target !== event.currentTarget && !event.target.classList.contains('modal-close-btn')) {
                return;
            }
            guideModalOverlay.classList.remove('show');
        }

        // --- Employee List Section Functions ---
        // This function will toggle the 'open' attribute of the details element
        function toggleEmployeeListSection() {
            employeeListDetails.open = !employeeListDetails.open;
            currentShamsiDateEmployeeListDisplay.textContent = `تاریخ امروز: ${toPersianDigits(CURRENT_SHAMSI_FULL_DATE)}`;
            renderEmployeeList(); // Ensure list is rendered when toggled
        }

        function printEmployeeList() {
            // Add a class to the body for print-specific styles
            document.body.classList.add('print-mode');
            // Open the details element to ensure content is visible for printing
            employeeListDetails.open = true;
            window.print();
            // Remove the print class after printing
            document.body.classList.remove('print-mode');
        }

        function printScoreDetails() {
            scoreDetailsModalOverlay.classList.add('print-modal');
            window.print();
            scoreDetailsModalOverlay.classList.remove('print-modal');
        }

        // --- Export to CSV Function ---
        function exportToCSV() {
            const headers = ['شماره پرسنلی', 'نام و نام خانوادگی', 'تاریخ استخدام', 'سابقه (سال)', 'خانواده (نفر)', 'امتیاز نهایی', 'تاریخ استفاده', 'آیا بازه محبوب بود؟']; // Changed for single usage date line per row
            const rows = [];

            let filteredAndSortedEmployees = [...employees];

            const searchTerm = toWesternDigits(searchEmployeeInput.value.trim().toLowerCase());
            if (searchTerm) {
                filteredAndSortedEmployees = employees.filter(emp =>
                    toWesternDigits(emp.name.toLowerCase()).includes(searchTerm) ||
                    toWesternDigits(emp.employeeId.toLowerCase()).includes(searchTerm) ||
                    toWesternDigits(emp.employmentDate.toLowerCase()).includes(searchTerm) ||
                    toWesternDigits(emp.familyMembers.toString()).includes(searchTerm) ||
                    (emp.score !== 0 && toPersianDigits(emp.score.toString()).includes(searchTerm)) || // Allow searching by Persian score
                    emp.usageDates.some(item => toWesternDigits(item.date).includes(searchTerm))
                );
            }

            filteredAndSortedEmployees.sort((a, b) => {
                let valA, valB;

                if (sortColumn === 'yearsOfService') {
                    const yearsA = CURRENT_SHAMSI_YEAR - getShamsiYearFromDateString(a.employmentDate);
                    const yearsB = CURRENT_SHAMSI_YEAR - getShamsiYearFromDateString(b.employmentDate);
                    valA = isNaN(yearsA) ? -Infinity : Math.max(0, yearsA);
                    valB = isNaN(yearsB) ? -Infinity : Math.max(0, yearsB);
                } else if (sortColumn === 'name' || sortColumn === 'employeeId' || sortColumn === 'employmentDate') {
                    valA = toWesternDigits(a[sortColumn]);
                    valB = toWesternDigits(b[sortColumn]);
                } else {
                    valA = a[sortColumn];
                    valB = b[sortColumn];
                }

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });


            filteredAndSortedEmployees.forEach(emp => {
                const yearsOfService = CURRENT_SHAMSI_YEAR - getShamsiYearFromDateString(emp.employmentDate);
                
                // For CSV, each usage date gets its own row for clarity if multiple dates exist
                if (emp.usageDates.length === 0) {
                     rows.push([
                        `"${toPersianDigits(emp.employeeId)}"`,
                        `"${toPersianDigits(emp.name)}"`,
                        `"${toPersianDigits(emp.employmentDate)}"`,
                        `"${isNaN(yearsOfService) ? 'نامعتبر' : toPersianDigits(Math.max(0, yearsOfService).toString())}"`,
                        `"${toPersianDigits(emp.familyMembers.toString())}"`,
                        `"${emp.score === 0 ? 'محاسبه نشده' : toPersianDigits(emp.score.toString())}"`,
                        `""`, // No usage date
                        `""`  // Not popular
                    ]);
                } else {
                    emp.usageDates.forEach(item => {
                         rows.push([
                            `"${toPersianDigits(emp.employeeId)}"`,
                            `"${toPersianDigits(emp.name)}"`,
                            `"${toPersianDigits(emp.employmentDate)}"`,
                            `"${isNaN(yearsOfService) ? 'نامعتبر' : toPersianDigits(Math.max(0, yearsOfService).toString())}"`,
                            `"${toPersianDigits(emp.familyMembers.toString())}"`,
                            `"${emp.score === 0 ? 'محاسبه نشده' : toPersianDigits(emp.score.toString())}"`,
                            `"${toPersianDigits(item.date)}"`,
                            `"${item.isPopularSlot ? 'بله' : 'خیر'}"`
                        ]);
                    });
                }
            });

            let csvContent = headers.join(',') + '\n' + rows.map(e => e.join(',')).join('\n');
            csvContent = '\ufeff' + csvContent;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `لیست_کارکنان_امتیازات_${toPersianDigits(CURRENT_SHAMSI_FULL_DATE.replace(/\//g, '_'))}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showCustomAlert('خطا در دانلود', 'مرورگر شما از قابلیت دانلود فایل پشتیبانی نمی‌کند.', 'alert');
            }
        }

        // --- Backup and Restore Functions ---

        async function exportJSONBackup() {
            try {
                const allEmployees = await getEmployeesFromDB();
                const jsonString = JSON.stringify(allEmployees, null, 2);

                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `پشتیبان_کارکنان_${toPersianDigits(CURRENT_SHAMSI_FULL_DATE.replace(/\//g, '_'))}.json`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showCustomAlert('موفقیت', 'پشتیبان‌گیری با موفقیت انجام شد.', 'alert');
                } else {
                    showCustomAlert('خطا در دانلود', 'مرورگر شما از قابلیت دانلود فایل پشتیبانی نمی‌کند.', 'alert');
                }
            } catch (error) {
                showCustomAlert('خطا در پشتیبان‌گیری', 'خطا در پشتیبان‌گیری: ' + error, 'alert');
            }
        }

        async function importFromJSONBackup(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const confirmed = await showCustomAlert('تایید بازیابی', 'با بازیابی فایل پشتیبان، تمام اطلاعات فعلی جایگزین خواهند شد. آیا مطمئن هستید؟ این عملیات قابل بازگشت نیست.', 'confirm');
            if (!confirmed) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) {
                        throw new Error('فرمت فایل پشتیبان نامعتبر است. لطفاً فایل JSON صحیح را انتخاب کنید.');
                    }

                    await clearAllEmployeesInDB();
                    employees = [];

                    for (const emp of data) {
                        delete emp.id; // Ensure new ID is generated by IndexedDB
                        const restoredUsageDates = Array.isArray(emp.usageDates)
                            ? emp.usageDates.map(item => {
                                // Handle both old string format and new object format from JSON backup
                                if (typeof item === 'string') {
                                    return { date: toWesternDigits(item || ''), isPopularSlot: false };
                                }
                                return {
                                    date: toWesternDigits(item.date || ''),
                                    isPopularSlot: item.isPopularSlot || false
                                };
                            })
                            : [];

                        const restoredEmp = {
                            name: emp.name || '',
                            employeeId: toWesternDigits(emp.employeeId || ''),
                            employmentDate: toWesternDigits(emp.employmentDate || ''),
                            familyMembers: parseInt(emp.familyMembers) || 1,
                            usageDates: restoredUsageDates,
                            score: 0
                        };
                        const id = await addEmployeeToDB(restoredEmp);
                        restoredEmp.id = id;
                        employees.push(restoredEmp);
                    }
                    showCustomAlert('موفقیت', 'بازیابی اطلاعات با موفقیت انجام شد.', 'alert');
                    renderEmployeeList(); // Render the collapsible list
                } catch (error) {
                    showCustomAlert('خطا در بازیابی', 'خطا در بازیابی اطلاعات: ' + error, 'alert');
                    console.error('Restore error:', error);
                } finally {
                    event.target.value = '';
                }
            };
            reader.onerror = () => {
                showCustomAlert('خطا در خواندن فایل', 'خطا در خواندن فایل پشتیبان.', 'alert');
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // --- Monthly Quota and Lottery Logic ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
            return array;
        }

        // Function to show the modal for monthly winners selection
        function showMonthlyWinnersNewModal() {
            monthlyWinnersNewModalOverlay.classList.add('show');
        }

        // Function to hide the modal for monthly winners selection
        function hideMonthlyWinnersNewModal(event) {
             if (event && event.target !== event.currentTarget && !event.target.classList.contains('modal-close-btn')) {
                return;
            }
            monthlyWinnersNewModalOverlay.classList.remove('show');
        }

        async function selectMonthlyWinners() {
            const quota = parseInt(monthlyQuotaInput.value);

            if (isNaN(quota) || quota <= 0) {
                showCustomAlert('خطای ورودی', 'لطفاً یک عدد معتبر و مثبت برای سهمیه ماه جاری وارد کنید.', 'alert');
                return;
            }

            if (employees.length === 0) {
                showCustomAlert('اطلاعات ناکافی', 'هیچ کارمندی برای انتخاب وجود ندارد.', 'alert');
                return;
            }

            // Ensure all scores are calculated and up-to-date
            for (const emp of employees) {
                emp.score = calculateEmployeeScore(emp);
                // No need to await updateEmployeeInDB here, as it's just for current selection
            }

            // Sort employees by score (descending)
            const sortedEmployees = [...employees].sort((a, b) => b.score - a.score);

            let selectedWinners = [];
            let remainingQuota = quota;

            for (let i = 0; i < sortedEmployees.length && remainingQuota > 0; i++) {
                const currentEmployee = sortedEmployees[i];
                const currentScore = currentEmployee.score;

                // Find all employees with the same score at this point
                const tiedEmployees = [];
                let j = i;
                while (j < sortedEmployees.length && sortedEmployees[j].score === currentScore) {
                    tiedEmployees.push(sortedEmployees[j]);
                    j++;
                }

                if (tiedEmployees.length <= remainingQuota) {
                    // If all tied employees fit within the remaining quota, add them all
                    selectedWinners.push(...tiedEmployees);
                    remainingQuota -= tiedEmployees.length;
                    i = j - 1; // Advance outer loop index past all tied employees
                } else {
                    // Lottery needed! Not enough slots for all tied employees
                    const lotteryMessage = `تعداد ${toPersianDigits(tiedEmployees.length.toString())} نفر از کارکنان با امتیاز ${toPersianDigits(currentScore.toString())} مساوی هستند، اما تنها ${toPersianDigits(remainingQuota.toString())} سهمیه باقی مانده است. آیا مایل به انجام قرعه‌کشی بین این افراد هستید؟`;
                    const confirmedLottery = await showCustomAlert('قرعه‌کشی لازم است!', lotteryMessage, 'confirm');

                    if (confirmedLottery) {
                        const shuffledTied = shuffleArray(tiedEmployees);
                        const lotteryWinners = shuffledTied.slice(0, remainingQuota);
                        selectedWinners.push(...lotteryWinners);
                        remainingQuota = 0; // Quota filled after lottery
                        showCustomAlert('قرعه‌کشی انجام شد', `${toPersianDigits(lotteryWinners.length.toString())} نفر از افراد هم‌امتیاز از طریق قرعه‌کشی انتخاب شدند.`, 'alert');
                        break; // Stop processing, winners selected
                    } else {
                        // User cancelled lottery, stop selecting winners
                        showCustomAlert('قرعه‌کشی لغو شد', 'انتخاب برندگان متوقف شد.', 'alert');
                        renderMonthlyWinners([]); // Clear previous winners if any
                        hideMonthlyWinnersNewModal(); // Hide the selection modal
                        return;
                    }
                }
            }
            hideMonthlyWinnersNewModal(); // Hide the selection modal
            renderMonthlyWinners(selectedWinners);
            showMonthlyWinnersModal(); // Open the winners display modal
        }

        // Renders the monthly winners in the dedicated modal
        function renderMonthlyWinners(winners) {
            monthlyWinnersContainer.innerHTML = ''; // Clear previous content

            if (winners.length === 0) {
                const span = document.createElement('span');
                span.id = 'noWinnersTextModal';
                span.className = 'text-blue-600 font-medium';
                span.textContent = 'برندگان ماه هنوز انتخاب نشده‌اند.';
                monthlyWinnersContainer.appendChild(span);
                return;
            }

            const heading = document.createElement('h3');
            heading.className = 'text-2xl font-bold mb-3 text-blue-800 text-center w-full';
            heading.textContent = `برندگان ماه جاری (${toPersianDigits(winners.length.toString())} نفر):`;
            monthlyWinnersContainer.appendChild(heading);

            const ul = document.createElement('ul');
            ul.className = 'list-disc pr-6 mt-3 space-y-2 w-full';

            winners.forEach((winner, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center text-blue-700 font-medium text-lg bg-blue-100 p-2 rounded-lg shadow-sm';
                li.innerHTML = `
                    <span>${toPersianDigits((index + 1).toString())}. ${toPersianDigits(winner.name)} (شماره پرسنلی: ${toPersianDigits(winner.employeeId)})</span>
                    <span class="font-bold text-blue-900">${toPersianDigits(winner.score.toString())} امتیاز</span>
                `;
                ul.appendChild(li);
            });
            monthlyWinnersContainer.appendChild(ul);
            monthlyWinnersContainer.dataset.winners = JSON.stringify(winners); // Store for export/print
        }


        // Functions for Monthly Winners Display Modal
        function showMonthlyWinnersModal() {
            currentShamsiDateWinnersDisplay.textContent = `تاریخ امروز: ${toPersianDigits(CURRENT_SHAMSI_FULL_DATE)}`;
            monthlyWinnersModalOverlay.classList.add('show');
        }

        function hideMonthlyWinnersModal(event) {
            if (event && event.target !== event.currentTarget && !event.target.classList.contains('modal-close-btn')) {
                return;
            }
            monthlyWinnersModalOverlay.classList.remove('show');
        }

        function exportWinnersToCSV() {
            const winnersData = JSON.parse(monthlyWinnersContainer.dataset.winners || '[]');
            if (winnersData.length === 0) {
                showCustomAlert('خطا در خروجی', 'لیست برندگان برای خروجی گرفتن خالی است.', 'alert');
                return;
            }

            const headers = ['ردیف', 'نام و نام خانوادگی', 'شماره پرسنلی', 'امتیاز نهایی'];
            const rows = winnersData.map((winner, index) => [
                `"${toPersianDigits((index + 1).toString())}"`,
                `"${toPersianDigits(winner.name)}"`,
                `"${toPersianDigits(winner.employeeId)}"`,
                `"${toPersianDigits(winner.score.toString())}"`
            ]);

            let csvContent = headers.join(',') + '\n' + rows.map(e => e.join(',')).join('\n');
            csvContent = '\ufeff' + csvContent; // Add BOM for proper UTF-8 in Excel

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `برندگان_ماه_${toPersianDigits(CURRENT_SHAMSI_FULL_DATE.replace(/\//g, '_'))}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showCustomAlert('خطا در دانلود', 'مرورگر شما از قابلیت دانلود فایل پشتیبانی نمی‌کند.', 'alert');
            }
        }

        function printMonthlyWinners() {
            monthlyWinnersModalOverlay.classList.add('print-modal', 'print-winners-modal'); // Add print-modal for general modal printing styles
            window.print();
            monthlyWinnersModalOverlay.classList.remove('print-modal', 'print-winners-modal');
        }


        // --- Excel Import Function ---
        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (json.length === 0) {
                    showCustomAlert('خطای فایل اکسل', 'فایل اکسل خالی است یا فرمت آن صحیح نیست.', 'alert');
                    return;
                }

                // Map header names to expected internal keys, convert to Western digits for processing
                const headerRow = json[0].map(h => toWesternDigits(String(h || '').trim()));
                const dataRows = json.slice(1);

                const nameIndex = headerRow.indexOf('نام');
                const employeeIdIndex = headerRow.indexOf('شماره پرسنلی');
                const employmentDateIndex = headerRow.indexOf('تاریخ استخدام');
                const familyMembersIndex = headerRow.indexOf('تعداد اعضای خانواده');
                const usageDatesIndex = headerRow.indexOf('تاریخ‌های استفاده قبلی');
                const isPopularSlotIndex = headerRow.indexOf('آیا بازه محبوب بود؟'); // New header index

                if (nameIndex === -1 || employeeIdIndex === -1 || employmentDateIndex === -1 || familyMembersIndex === -1) {
                    showCustomAlert('خطای فرمت اکسل', 'نام ستون‌های "نام", "شماره پرسنلی", "تاریخ استخدام", "تعداد اعضای خانواده" در فایل اکسل یافت نشد. لطفاً راهنما را مطالعه کنید.', 'alert');
                    return;
                }

                for (const row of dataRows) {
                    const employeeId = toWesternDigits(String(row[employeeIdIndex] || '').trim());
                    if (!employeeId) continue; // Skip rows without an employee ID

                    let existingEmployee = employees.find(emp => emp.employeeId === employeeId);

                    const newUsageDates = [];
                    if (usageDatesIndex !== -1 && row[usageDatesIndex]) {
                        const datesStr = String(row[usageDatesIndex]);
                        const popularSlotsStr = isPopularSlotIndex !== -1 ? String(row[isPopularSlotIndex] || '') : '';

                        const datesArray = datesStr.split(',').map(d => toWesternDigits(d.trim())).filter(d => d);
                        const popularSlotsArray = popularSlotsStr.split(',').map(s => String(s || '').trim().toLowerCase());

                        datesArray.forEach((date, index) => {
                            let isPopular = false;
                            const popularIndicator = popularSlotsArray[index];
                            if (popularIndicator === 'بله' || popularIndicator === 'yes' || popularIndicator === '1') {
                                isPopular = true;
                            }
                            newUsageDates.push({ date: date, isPopularSlot: isPopular });
                        });
                    }

                    const newEmployeeData = {
                        name: String(row[nameIndex] || '').trim(),
                        employeeId: employeeId,
                        employmentDate: toWesternDigits(String(row[employmentDateIndex] || '').trim()),
                        familyMembers: parseInt(row[familyMembersIndex]) || 1,
                        usageDates: newUsageDates,
                        score: 0
                    };

                    try {
                        if (existingEmployee) {
                            // Update existing employee
                            newEmployeeData.id = existingEmployee.id;
                            await updateEmployeeInDB(newEmployeeData);
                            Object.assign(existingEmployee, newEmployeeData); // Update in local array
                        } else {
                            // Add new employee
                            const id = await addEmployeeToDB(newEmployeeData);
                            newEmployeeData.id = id;
                            employees.push(newEmployeeData);
                        }
                    } catch (error) {
                        console.error(`Error processing employee ${newEmployeeData.employeeId}:`, error);
                        // showCustomAlert('خطای پردازش', `خطا در پردازش کارمند با شماره پرسنلی ${toPersianDigits(newEmployeeData.employeeId)}: ${error}`, 'alert');
                    }
                }
                showCustomAlert('موفقیت', 'اطلاعات کارکنان با موفقیت از فایل اکسل وارد یا به‌روزرسانی شد.', 'alert');
                renderEmployeeList(); // Render the collapsible list
            };

            reader.onerror = (error) => {
                showCustomAlert('خطا در خواندن فایل', 'خطا در خواندن فایل اکسل.', 'alert');
                console.error('File reader error:', error);
            };

            reader.readAsArrayBuffer(file);
        }

        // --- Initialization ---
        async function init() {
            try {
                await openDatabase();
                const storedEmployees = await getEmployeesFromDB();
                employees.push(...storedEmployees);
                
                // Calculate initial scores for all employees, then render
                for (const emp of employees) {
                    emp.score = calculateEmployeeScore(emp);
                    // No need to await updateEmployeeInDB here, as they are already in DB.
                    // This is just to update the `score` property in the local `employees` array.
                }

                renderEmployeeList(); // Initial render for the collapsible list
                renderCurrentUsageDates();
                
                // Add event listener for window resize to adjust body alignment if content overflows
                window.addEventListener('resize', checkContentOverflow);
                checkContentOverflow(); // Initial check
            } catch (error) {
                showCustomAlert('خطای راه‌اندازی', error.message || 'خطا در راه‌اندازی برنامه.', 'alert');
            }
        }

        // Function to check if content overflows and adjust body alignment
        function checkContentOverflow() {
            const body = document.body;
            const container = document.querySelector('.container-wrapper');
            // Compare the container's actual height with the available viewport height minus body padding
            const bodyStyle = getComputedStyle(body);
            const bodyPaddingTop = parseFloat(bodyStyle.paddingTop);
            const bodyPaddingBottom = parseFloat(bodyStyle.paddingBottom);
            
            if (container && (container.offsetHeight + bodyPaddingTop + bodyPaddingBottom) > window.innerHeight) {
                body.classList.add('content-overflow');
                body.style.alignItems = 'flex-start'; // Align to top if content overflows
            } else {
                body.classList.remove('content-overflow');
                body.style.alignItems = 'center'; // Center if content fits
            }
        }

        init();
    </script>
</body>
</html>
